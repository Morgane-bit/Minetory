<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R√©servation - Location Maisons</title>
<style>
/* --- Reset & global --- */
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; color:#333; transition: background 0.3s, color 0.3s; }
header { background:#2c3e50; color:white; padding:1rem; text-align:center; position: sticky; top:0; z-index:1000; }
nav a { color:white; margin:0 10px; text-decoration:none; font-weight:bold; }
nav a.active { text-decoration:underline; }
.container { max-width:1000px; margin:20px auto; padding:0 15px; }
.loader, .error, .toast { text-align:center; padding:10px; }
.error { color:red; }
.toast { position: fixed; bottom: 20px; left:50%; transform: translateX(-50%); background: #2c3e50; color:white; padding:10px 20px; border-radius:5px; display:none; z-index:1001; }

/* --- Section Images --- */
.images-section { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px; }
.images-section h3 { margin-top:0; }
.images-gallery { position: relative; }
.images-gallery img.main { width:100%; max-height:400px; object-fit:contain; border-radius:10px; cursor:pointer; transition: transform 0.3s; }
.images-gallery img.main:hover { transform: scale(1.03); }
.images-gallery .thumbnails { display:flex; gap:5px; margin-top:10px; overflow-x:auto; }
.images-gallery .thumbnails img { width:80px; height:60px; object-fit:cover; cursor:pointer; border-radius:5px; transition: 0.3s; opacity:0.7; }
.images-gallery .thumbnails img.active { border:2px solid #2c3e50; opacity:1; }

/* --- Details --- */
.details, .contact { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-top:20px; animation: fadeIn 0.5s; }
.details h2 { margin-top:0; }
.details p { margin:5px 0; color:#555; }
.badge { display:inline-block; background:#27ae60; color:white; padding:3px 8px; border-radius:5px; font-size:12px; margin-right:5px; }

/* --- Contact Form --- */
.contact input, .contact textarea, .contact button { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
.contact button { background:#2c3e50; color:white; border:none; cursor:pointer; transition:0.3s; }
.contact button:hover { background:#1a252f; }

/* --- Cancel button --- */
#cancel-choice { margin-top:15px; background:#e74c3c; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; transition:0.3s; }
#cancel-choice:hover { background:#c0392b; }

/* --- Footer --- */
footer { background:#f4f4f4; padding:30px; margin-top:40px; text-align:center; border-top:1px solid #ddd; }
footer a { margin:0 5px; text-decoration:none; color:#1abc9c; }

/* --- Dark mode global --- */
body.dark { background:#121212; color:#f5f5f5; }
body.dark header { background:#1e1e1e; color:#f5f5f5; }
body.dark nav a { color:#f5f5f5; }
body.dark .images-gallery img.active { border:2px solid #1e90ff; }
body.dark .details, body.dark .contact, body.dark .images-section { background:#1e1e1e; color:#f5f5f5; box-shadow:0 2px 5px rgba(0,0,0,0.5); }
body.dark input, body.dark textarea { background:#333; color:white; border:1px solid #555; }
body.dark button { background:#2c3e50; color:white; }
body.dark button:hover { background:#1a252f; }
body.dark footer { background:#1e1e1e; color:#f5f5f5; border-top:1px solid #555; }
body.dark .badge { background:#1e90ff; color:white; }

/* --- Animations --- */
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

/* Bouton retour haut */
#topBtn { display:none; position:fixed; bottom:30px; right:30px; z-index:999; background:#2c3e50; color:#fff; border:none; padding:10px 15px; border-radius:50%; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>üè° Location Maisons</h1>
  <nav>
    <a href="accueil.html">Accueil</a> |
    <a href="favoris.html" > Mes favoris</a> |
    <a href="connexion.html">Connexion / Inscription</a> | 
    <a href="Tableau de bord.html">Tableau de bord</a>
    <button id="toggle-dark" style="margin-left:15px;padding:5px 10px;cursor:pointer;">üåô</button>
  </nav>
</header>

<div class="container">

  <!-- Section Images -->
  <div class="images-section">
    <h3>Galerie de la maison</h3>
    <div class="images-gallery" id="images-gallery">
      <div class="thumbnails" id="images-thumbnails"></div>
    </div>
  </div>

  <!-- Details -->
  <div id="details" class="details">
    <h2 id="titre">Chargement...</h2>
    <div id="badges"></div>
    <p id="localisation"></p>
    <p id="prix"></p>
    <p id="caracteristiques"></p>
    <p id="description"></p>
    <p id="owner-contact" style="margin-top:10px;"></p>
    <button id="cancel-choice">‚ùå Annuler cette r√©servation</button>
  </div>

  <!-- Contact Form -->
  <div class="contact">
    <h3>Contacter le propri√©taire</h3>
    <div id="form-status" class="loader" hidden></div>
    <form id="contact-form" novalidate>
      <input type="text" name="nomClient" placeholder="Votre nom" required>
      <input type="email" name="emailClient" placeholder="Votre email" required>
      <input type="tel" name="telephone" placeholder="Votre num√©ro WhatsApp" required>
      <textarea name="content" placeholder="Votre message" rows="5" maxlength="500" required></textarea>
      <small id="char-count" style="float:right;color:#555;">0/500</small>
      <button type="submit">Envoyer</button>
    </form>
    <p style="margin-top:10px; color:#555;" id="whatsapp-container" hidden>
      Ou contactez directement via WhatsApp :
      <a id="whatsapp-link" href="#" target="_blank" rel="noopener noreferrer"></a>
    </p>
    <p id="contact-error" class="error" hidden></p>
  </div>

</div>

<button id="topBtn" title="Retour en haut">‚Üë</button>
<footer>
  <div>
    <h3>Location Maisons</h3>
    <p>Votre plateforme pour trouver ou publier des maisons √† louer facilement.</p>
  </div>
  <div>
    <a href="accueil.html">Accueil</a> |
    <a href="favoris.html" > Mes favoris</a> |
    <a href="connexion.html">Connexion / Inscription</a> |
    <a href="Tableau de bord.html">Tableau de bord</a>
  </div>
  <div style="margin-top:10px;">
    <p>üìß contact@locationmaisons.com | üìû +229 90 00 00 00</p>
  </div>
</footer>

<div id="toast" class="toast"></div>

<script>
const BASE_URL = 'http://localhost:3000/api';

// --- Dark mode toggle ---
const toggleBtn = document.getElementById('toggle-dark');
function setDarkMode(on){
  document.body.classList.toggle('dark', on);
  toggleBtn.textContent = on ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('darkMode', on ? 'on' : 'off');
}
setDarkMode(localStorage.getItem('darkMode')==='on');
toggleBtn.addEventListener('click', ()=> setDarkMode(!document.body.classList.contains('dark')));

// --- Load selected house ---
const maison = JSON.parse(localStorage.getItem('maisonSelectionnee') || '{}');

if (!maison || !maison._id) {
  alert("Aucune maison s√©lectionn√©e !");
  document.getElementById('titre').textContent = "Maison introuvable";
} else {
  // Badges
  const badgesDiv = document.getElementById('badges');
  if(maison.nouveau) badgesDiv.innerHTML += '<span class="badge">Nouveau</span>';
  if(maison.populaire) badgesDiv.innerHTML += '<span class="badge">Populaire</span>';

  // Galerie images
  const gallery = document.getElementById('images-gallery');
  const thumbnails = document.getElementById('images-thumbnails');
  const images = (maison.images && maison.images.length)
  ? maison.images.map(i => `${BASE_URL.replace('/api','')}/uploads/${i}`)
  : ['https://via.placeholder.com/400x250'];

  let currentIndex = 0;
  const mainImg = document.createElement('img');
  mainImg.classList.add('main');
  mainImg.src = images[0];
  mainImg.alt = maison.titre;
  mainImg.loading = 'lazy';
  gallery.insertBefore(mainImg, thumbnails);

  function updateGallery(index){
    mainImg.src = images[index];
    currentIndex = index;
    thumbnails.querySelectorAll('img').forEach((thumb,i)=>thumb.classList.toggle('active', i===index));
  }

  thumbnails.innerHTML = '';
  images.forEach((src,i)=>{
    const thumb = document.createElement('img');
    thumb.src = src;
    thumb.alt = maison.titre;
    thumb.loading = 'lazy';
    thumb.addEventListener('click',()=>updateGallery(i));
    thumbnails.appendChild(thumb);
  });
  updateGallery(0);

  // D√©tails
  document.getElementById('titre').textContent = maison.titre || 'Sans titre';
  document.getElementById('localisation').textContent = `üìç Localisation : ${maison.localisation || 'N/A'}`;
  document.getElementById('prix').textContent = `üíµ Prix : ${maison.prix || 'N/A'} FCFA / mois`;
  document.getElementById('description').textContent = `Description : ${maison.description || 'Aucune description'}`;
  if(maison.caracteristiques) document.getElementById('caracteristiques').textContent = `Caract√©ristiques : ${maison.caracteristiques}`;

  // WhatsApp
  if(maison.telephoneProprietaire){
    const tel = maison.telephoneProprietaire.replace(/\D/g,'');
    const whatsappLink = document.getElementById('whatsapp-link');
    whatsappLink.href = `https://wa.me/${tel}`;
    whatsappLink.textContent = maison.telephoneProprietaire;
    document.getElementById('whatsapp-container').hidden = false;
  }
}

// --- Contact Form ---
const form = document.getElementById('contact-form');
const contactError = document.getElementById('contact-error');
const statusEl = document.getElementById('form-status');
const toast = document.getElementById('toast');
const charCount = document.getElementById('char-count');
form.content.addEventListener('input', ()=>charCount.textContent = `${form.content.value.length}/500`);

function showToast(msg){
  toast.textContent = msg;
  toast.style.display='block';
  setTimeout(()=>toast.style.display='none',3000);
}

form.addEventListener('submit', async e=>{
  e.preventDefault();
  contactError.hidden=true;
  const payload = {
    nomClient: form.nomClient.value.trim(),
    email: form.emailClient.value.trim(),
    telephone: form.telephone.value.trim(),
    message: form.content.value.trim(),
    maisonId: maison._id
  };
  if(!payload.nomClient||!payload.email||!payload.telephone||!payload.message){
    contactError.textContent="Veuillez remplir tous les champs obligatoires";
    contactError.hidden=false; return;
  }
  const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailRegex.test(payload.email)){ contactError.textContent="Email invalide"; contactError.hidden=false; return; }
  if(payload.telephone.length<8){ contactError.textContent="Num√©ro invalide"; contactError.hidden=false; return; }
  statusEl.hidden=false; statusEl.textContent="Envoi en cours‚Ä¶";
  try{
    const res = await fetch(`${BASE_URL}/messages`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if(result && result.success){
      showToast("Message envoy√© au propri√©taire !");
      form.reset();
      charCount.textContent='0/500';
    } else {
      contactError.textContent = result.error || "Erreur lors de l'envoi";
      contactError.hidden=false;
    }
  } catch(err){
    contactError.textContent="Erreur r√©seau. R√©essayez.";
    contactError.hidden=false;
  } finally{ statusEl.hidden=true; }
});

// --- Annulation r√©servation ---
document.getElementById('cancel-choice').addEventListener('click',()=>{
  if(confirm("Voulez-vous vraiment annuler cette r√©servation ?")){
    localStorage.removeItem('maisonSelectionnee');
    showToast("R√©servation annul√©e !");
    setTimeout(()=> window.location.href="accueil.html",1000);
  }
});

// --- Bouton retour en haut ---
const topBtn = document.getElementById("topBtn");
window.addEventListener("scroll", () => topBtn.style.display = window.scrollY > 200 ? "block" : "none");
topBtn.addEventListener("click", () => window.scrollTo({top:0, behavior:'smooth'}));
</script>

</body>
</html>
